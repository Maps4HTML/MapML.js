/*! mapml-leaflet-client 05-08-2016 */
function URI(a){a||(a="");var b=/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/,c=a.match(b);this.scheme=c[1]||null,this.authority=c[2]||null,this.path=c[3]||null,this.query=c[4]||null,this.fragment=c[5]||null}URI.prototype.toString=function(){var a="";return this.scheme&&(a+=this.scheme+":"),this.authority&&(a+="//"+this.authority),this.path&&(a+=this.path),this.query&&(a+="?"+this.query),this.fragment&&(a+="#"+this.fragment),a},function(){function a(a,b){var c=/^(.*)\//;return a.authority&&!a.path?"/"+b:a.path.match(c)[0]+b}function b(a){if(!a)return"";var b=a.replace(/\/\.\//g,"/");for(b=b.replace(/\/\.$/,"/");b.match(c);)b=b.replace(c,"/");for(b=b.replace(/\/([^\/]*)\/\.\.$/,"/");b.match(/\/\.\.\//);)b=b.replace(/\/\.\.\//,"/");return b}var c=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI.prototype.resolve=function(c){var d=new URI;return this.scheme?(d.scheme=this.scheme,d.authority=this.authority,d.path=b(this.path),d.query=this.query):(this.authority?(d.authority=this.authority,d.path=b(this.path),d.query=this.query):(this.path?("/"===this.path.charAt(0)?d.path=b(this.path):(d.path=a(c,this.path),d.path=b(d.path)),d.query=this.query):(d.path=c.path,this.query?d.query=this.query:d.query=c.query),d.authority=c.authority),d.scheme=c.scheme),d.fragment=this.fragment,d}}(),function(a,b,c){var d={};a.M=d,function(){d.mime="text/mapml",d.CBMTILE=new L.Proj.CRS("EPSG:3978","+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs",{resolutions:[38364.660062653464,22489.62831258996,13229.193125052918,7937.5158750317505,4630.2175937685215,2645.8386250105837,1587.5031750063501,926.0435187537042,529.1677250021168,317.50063500127004,185.20870375074085,111.12522225044451,66.1459656252646,38.36466006265346,22.48962831258996,13.229193125052918,7.9375158750317505,4.6302175937685215,2.6458386250105836,1.5875031750063502],origin:[-34655800,3931e4]}),d.APSTILE=new L.Proj.CRS("EPSG:5936","+proj=stere +lat_0=90 +lat_ts=50 +lon_0=-150 +k=0.994 +x_0=2000000 +y_0=2000000 +datum=WGS84 +units=m +no_defs",{resolutions:[238810.813354,119405.406677,59702.7033384999,29851.3516692501,14925.675834625,7462.83791731252,3731.41895865639,1865.70947932806,932.854739664032,466.427369832148,233.213684916074,116.606842458037,58.3034212288862,29.1517106145754,14.5758553072877,7.28792765351156,3.64396382688807,1.82198191331174,.910990956788164,.45549547826179],origin:[-28567784.109255,32567784.109255]}),d.BCTILE=new L.Proj.CRS("EPSG:3005","+proj=aea +lat_1=50 +lat_2=58.5 +lat_0=45 +lon_0=-126 +x_0=1000000 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs ",{resolutions:[9783.9400003175,4891.969998835831,2445.9849999470835,1222.9925001058336,611.4962500529168,305.74812489416644,152.8740625,76.4370312632292,38.2185156316146,19.10925781316146,9.554628905257811,4.7773144526289055,2.3886572265790367,1.1943286131572264],origin:[-13239300,19868500]}),d.OSMTILE=L.CRS.EPSG3857}(),d.Util={coordsToArray:function(a){for(var b=1,c=[],d=a.split(",");b<d.length;b+=2)c.push([parseInt(d[b-1]),parseInt(d[b])]);return c}},d.coordsToArray=d.Util.coordsToArray,d.ImageOverlay=L.ImageOverlay.extend({initialize:function(a,b,c,d,e,f){this._container=e,this._url=a,this._location=b,this._size=L.point(c),this._angle=d,L.setOptions(this,f)},getEvents:function(){var a={viewreset:this._reset};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},onAdd:function(){this._image||(this._initImage(),this.options.opacity<1&&this._updateOpacity()),this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),this.addInteractiveTarget(this._image)),Polymer.dom(this._container).appendChild(this._image),this._reset()},onRemove:function(){L.DomUtil.remove(this._image),this.options.interactive&&this.removeInteractiveTarget(this._image)},_animateZoom:function(a){var b=this._map.getZoomScale(a.zoom),c=this._map.getPixelOrigin().add(this._location).multiplyBy(b).subtract(this._map._getNewPixelOrigin(a.center,a.zoom)).round();L.Browser.any3d?L.DomUtil.setTransform(this._image,c,b):L.DomUtil.setPosition(this._image,c)},_reset:function(){var a=this._image,b=this._location,c=this._size;L.DomUtil.setPosition(a,b),a.style.width=c.x+"px",a.style.height=c.y+"px"}}),d.imageOverlay=function(a,b,c,e,f,g){return new d.ImageOverlay(a,b,c,e,f,g)},d.MapMLLayer=L.Layer.extend({options:{maxNext:10,zIndex:0},initialize:function(a,b,c){a&&(this._href=a);var d=!!b.querySelector("image,feature,tile");d&&(this._content=b),this._el=L.DomUtil.create("div","mapml-layer"),this._initExtent(d?b:null),this.on("attached",this._validateExtent,this),L.setOptions(this,c)},onAdd:function(a){this._map=a,this._mapmlvectors||(this._mapmlvectors=d.mapMlFeatures(null,{opacity:this.options.opacity,onEachFeature:function(a,b){var c;c=b instanceof L.Polygon?"Polygon":b instanceof L.Polyline?"LineString":b instanceof L.Marker?"Point":"Unknown";for(var d="<p>Type: "+c+"</p>",e=0;e<a.childNodes.length;e++)a.childNodes[e].nodeType===Node.ELEMENT_NODE&&(d+=a.childNodes[e].tagName+" = "+a.childNodes[e].textContent+"<br>");b.bindPopup(d,{autoPan:!0})}})),a.addLayer(this._mapmlvectors),this._imageLayer||(this._imageLayer=L.layerGroup()),a.addLayer(this._imageLayer),this._tileLayer||(this._tileLayer=d.mapMLTileLayer(this.href?this.href:this._href,this.options)),this._tileLayer._el=this._el,a.addLayer(this._tileLayer),this._tileLayer._container.appendChild(this._el),this._extent?this._onMoveEnd():this.once("extentload",this._onMoveEnd,this)},addTo:function(a){return a.addLayer(this),this},getEvents:function(){return{zoom:this._reset,moveend:this._onMoveEnd}},onRemove:function(a){this._mapmlvectors.clearLayers(),a.removeLayer(this._mapmlvectors),a.removeLayer(this._tileLayer),a.removeLayer(this._imageLayer)},getZoomBounds:function(){if(this._extent){var a={},b=this._extent.querySelector("[type=zoom]").getAttribute("min"),c=this._extent.querySelector("[type=zoom]").getAttribute("max");return a.min=Math.min(b,c),a.max=Math.max(b,c),a}},getLayerExtentBounds:function(a){if(this._extent){var b,c,e,f,g,h,i,j,k=a.getZoom(),l=a.options.projection,m=l!==this._extent.querySelector("[type=projection]").getAttribute("value");if(h=this._extent.querySelector("[type=xmin]").getAttribute("min"),i=this._extent.querySelector("[type=xmax]").getAttribute("min"),c=Math.min(h,i),h=this._extent.querySelector("[type=xmin]").getAttribute("max"),i=this._extent.querySelector("[type=xmax]").getAttribute("max"),f=Math.max(h,i),h=this._extent.querySelector("[type=ymin]").getAttribute("min"),i=this._extent.querySelector("[type=ymax]").getAttribute("min"),e=Math.min(h,i),h=this._extent.querySelector("[type=ymin]").getAttribute("max"),i=this._extent.querySelector("[type=ymax]").getAttribute("max"),g=Math.max(h,i),m){b=d[l];var n=[b.latLngToPoint(L.latLng([e,c]),k),b.latLngToPoint(L.latLng([g,f]),k),b.latLngToPoint(L.latLng([e,c]),k),b.latLngToPoint(L.latLng([e,f]),k)];return L.bounds(n)}return j=parseInt(this._extent.querySelector("[type=zoom]").getAttribute("value")),j!==k?(b=d[l],L.bounds(b.latLngToPoint(b.pointToLatLng(L.point(c,e),j),k),b.latLngToPoint(b.pointToLatLng(L.point(f,g),j),k))):L.bounds(L.point(c,e),L.point(f,g))}},getAttribution:function(){return this.options.attribution},setZIndex:function(a){return this.options.zIndex=a,this._updateZIndex(),this},_updateZIndex:function(){this._container&&this.options.zIndex!==c&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},_initExtent:function(a){function b(a,b){f.onreadystatechange=function(){if(this.readyState===this.DONE){if(200===this.status&&this.callback)return void this.callback.apply(this,this.arguments);400!==this.status&&404!==this.status&&500!==this.status&&406!==this.status||(e.error=!0,e.fire("extentload",e,!0),f.abort())}},f.arguments=Array.prototype.slice.call(arguments,2),f.onload=b,f.onerror=function(){e.error=!0,e.fire("extentload",e,!0)},f.open("GET",a),f.setRequestHeader("Accept",d.mime),f.overrideMimeType("text/xml"),f.send()}function c(a){var b=this.responseXML||a;if(b){var c=b.querySelector("extent");c||(c=e._synthesizeExtent(b),b.querySelector("feature,image,tile")&&(e._content=b)),e._parseLicenseAndLegend(b,e),e._extent=c,e._map&&(e._validateExtent(),e._map.hasLayer(e)&&e._map.attributionControl.addAttribution(e.getAttribution()),e._map.fire("moveend",e))}else e.error=!0;e.fire("extentload",e,!1)}if(this._href||a){var e=this;if(this._href){var f=new XMLHttpRequest;b(this._href,c)}else a&&c(a)}},_getMapML:function(a){function c(a,b){i.onreadystatechange=function(){if(this.readyState===this.DONE){if(200===this.status&&this.callback)return void this.callback.apply(this,this.arguments);400!==this.status&&404!==this.status&&500!==this.status&&406!==this.status||(g.error=!0,g.fire("extentload",g,!0),i.abort())}},i.arguments=Array.prototype.slice.call(arguments,2),i.onload=b,i.onerror=function(){console.error(this.statusText),g.error=!0},i.open("GET",a),i.setRequestHeader("Accept",d.mime+";projection="+g.options.projection+";zoom="+g.zoom),i.overrideMimeType("text/xml"),i.send()}function e(a){var i,j=this.responseXML||a;if(j){if(0===h){var k=j.querySelector("extent");k||(k=g._synthesizeExtent(j)),g._extent=k,g._parseLicenseAndLegend(j,g)}if(j.querySelector("feature")&&g._mapmlvectors.addData(j),j.querySelector("tile")){var l=b.createElement("tiles"),m=j.getElementsByTagName("tile");for(i=0;i<m.length;i++)Polymer.dom(l).appendChild(b.importNode(m[i],!0));g._el.appendChild(l)}if(j.querySelector("image")){var n=j.getElementsByTagName("image"),o=[],p=g._el.parentElement;for(i=0;i<n.length;i++){var q=n[i],r=q.getAttribute("src"),s=g._map,t=s.getPixelBounds().min.subtract(s.getPixelOrigin()),u=s.getSize();o[i]=d.imageOverlay(r,t,u,0,p)}var v=g._imageLayer.getLayers(),w=o.length-1;for(i=0;i<o.length;i++)g._imageLayer.addLayer(o[i]),i===w&&o[i].on("load",function(){for(var a=0;a<v.length;a++)g._imageLayer.removeLayer(v[a])})}var x=f("next",j);x&&h<g.options.maxNext?(h++,c(x,e)):(g._el.getElementsByTagName("tile").length>0&&g._tileLayer._onMoveEnd(),g.fire("extentload",g,!0))}}function f(a,b){var c=b.querySelector("base"),d=c?c.getAttribute("href"):null,e=new URI(d||b.baseURI),f=b.querySelector("link[rel="+a+"]"),g=f?new URI(f.getAttribute("href")).resolve(e):null;return g}var g=this;if(a){var h=0,i=new XMLHttpRequest;this._map.once("movestart",function(){i.abort()}),c(a,e)}else this._content&&e(this._content)},_createExtent:function(){var a=b.createElement("extent"),c=b.createElement("input"),d=b.createElement("input"),e=b.createElement("input"),f=b.createElement("input"),g=b.createElement("input"),h=b.createElement("input");return g.setAttribute("type","zoom"),g.setAttribute("min","0"),g.setAttribute("max","0"),c.setAttribute("type","xmin"),c.setAttribute("min",""),c.setAttribute("max",""),d.setAttribute("type","ymin"),d.setAttribute("min",""),d.setAttribute("max",""),e.setAttribute("type","xmax"),e.setAttribute("min",""),e.setAttribute("max",""),f.setAttribute("type","ymax"),f.setAttribute("min",""),f.setAttribute("max",""),h.setAttribute("type","projection"),h.setAttribute("value","WGS84"),a.setAttribute("action","synthetic"),Polymer.dom(a).appendChild(c),Polymer.dom(a).appendChild(d),Polymer.dom(a).appendChild(e),Polymer.dom(a).appendChild(f),Polymer.dom(a).appendChild(g),Polymer.dom(a).appendChild(h),a},_validateExtent:function(){var a=this._extent;if(a&&a.querySelector&&this._map){if(a.querySelector('[type=xmin][min=""], [type=xmin][max=""], [type=xmax][min=""], [type=xmax][max=""], [type=ymin][min=""], [type=ymin][max=""]')){var b,c,d=a.querySelector("[type=xmin]"),e=a.querySelector("[type=ymin]"),f=a.querySelector("[type=xmax]"),g=a.querySelector("[type=ymax]"),h=a.querySelector("[type=projection][value]");h?(c=h.getAttribute("value"),c&&"WGS84"===c?(b=this._map.getBounds(),d.setAttribute("min",b.getWest()),d.setAttribute("max",b.getEast()),e.setAttribute("min",b.getSouth()),e.setAttribute("max",b.getNorth()),f.setAttribute("min",b.getWest()),f.setAttribute("max",b.getEast()),g.setAttribute("min",b.getSouth()),g.setAttribute("max",b.getNorth())):c&&(b=this._map.getPixelBounds(),d.setAttribute("min",b.getBottomLeft().x),d.setAttribute("max",b.getTopRight().x),e.setAttribute("min",b.getTopRight().y),e.setAttribute("max",b.getBottomLeft().y),f.setAttribute("min",b.getBottomLeft().x),f.setAttribute("max",b.getTopRight().x),g.setAttribute("min",b.getTopRight().y),g.setAttribute("max",b.getBottomLeft().y))):this.error=!0}if(a.querySelector('[type=zoom][min=""], [type=zoom][max=""]')){var i=a.querySelector("[type=zoom]");i.setAttribute("min",this._map.getMinZoom()),i.setAttribute("max",this._map.getMaxZoom())}}},_getMapMLExtent:function(a,b,d){var e=this._createExtent(),f=e.querySelector("input[type=zoom]"),g=e.querySelector("input[type=xmin]"),h=e.querySelector("input[type=ymin]"),i=e.querySelector("input[type=xmax]"),j=e.querySelector("input[type=ymax]"),k=e.querySelector("input[type=projection]"),l=b[0]!==c&&b[1]!==c?Math.min(b[0],b[1]):"",m=b[0]!==c&&b[1]!==c?Math.max(b[0],b[1]):"",n=a?a._southWest?a.getWest():a.getBottomLeft().x:"",o=a?a._southWest?a.getSouth():a.getTopRight().y:"",p=a?a._southWest?a.getEast():a.getTopRight().x:"",q=a?a._southWest?a.getNorth():a.getBottomLeft().y:"";return f.setAttribute("min","number"==typeof l&&isNaN(l)?"":l),f.setAttribute("max","number"==typeof m&&isNaN(m)?"":m),g.setAttribute("min",n),g.setAttribute("max",p),h.setAttribute("min",o),h.setAttribute("max",q),i.setAttribute("min",n),i.setAttribute("max",p),j.setAttribute("min",o),j.setAttribute("max",q),k.setAttribute("value",a&&a._southWest&&!d?"WGS84":d),e},_synthesizeExtent:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=a.querySelectorAll("meta[name=zoom]")[0],o=a.querySelector("meta[name=extent]"),p=a.querySelector("meta[name=projection]"),q=p?p.getAttribute("content"):"WGS84";if(n)for(c=n.getAttribute("content").split(","),b=0;b<c.length;b++)k=c[b].split("="),l=k[0],m=k[1],"min"===l&&(e=parseInt(m)),"max"===l&&(f=parseInt(m));if(o)for(c=o.getAttribute("content").split(","),b=0;b<c.length;b++)k=c[b].split("="),l=k[0],m=k[1],"xmin"===l&&(g=parseFloat(m)),"xmax"===l&&(i=parseFloat(m)),"ymin"===l&&(h=parseFloat(m)),"ymax"===l&&(j=parseFloat(m));if(g&&h&&i&&j&&"WGS84"===q){var r=L.latLng(h,g),s=L.latLng(j,i);d=L.latLngBounds(r,s)}else g&&h&&i&&j&&(d=L.bounds([[g,h],[i,j]]));return this._getMapMLExtent(d,[e,f],q)},getProjection:function(){if(!this._extent||!this._extent.querySelector("input[type=projection]"))return"WGS84";var a=this._extent.querySelector("input[type=projection]");return a.getAttribute("value")?a.getAttribute("value"):"WGS84"},_parseLicenseAndLegend:function(a,b){var c,d,e,f=a.querySelector("link[rel=license]");f&&(c=f.getAttribute("title"),d=f.getAttribute("href"),e='<a href="'+d+'" title="'+c+'">'+c+"</a>"),L.setOptions(b,{attribution:e});var g=a.querySelector("link[rel=legend]");g&&(b._legendUrl=g.getAttribute("href"))},_onMoveEnd:function(){var a=this._calculateUrl();a?(this.href=a,this._mapmlvectors.clearLayers(),this._initEl(),this._getMapML(a)):this._content&&!this._mapmlvectors.getLayers().length&&this._getMapML(null)},_initEl:function(){if(this._el)for(var a=this._el;a.firstChild;)a.removeChild(a.firstChild)},_reset:function(){this._initEl(),this._mapmlvectors.clearLayers()},_getUnprojectedMapLatLngBounds:function(a){return a=a||this._map,origin=a.getPixelOrigin(),bounds=a.getPixelBounds(),nw=a.unproject(origin),sw=a.unproject(bounds.getBottomLeft()),ne=a.unproject(bounds.getTopRight()),se=a.unproject(origin.add(a.getSize())),L.latLngBounds(sw,ne).extend(se).extend(nw)},_calculateUrl:function(){if(!this._map)return null;if(!this._el&&!this._extent)return this._href;var a=this._el.getElementsByTagName("extent")[0]||this._extent;if(!a)return this._href;var b=a.getAttribute("action");if(!b||"synthetic"===b)return null;var c,d=a.querySelectorAll("input[type=projection]")[0],e=d.getAttribute("value");c="WGS84"===e?this._getUnprojectedMapLatLngBounds():this._map.getPixelBounds();var f=a.querySelectorAll("input[type=xmin]")[0],g=a.querySelectorAll("input[type=ymin]")[0],h=a.querySelectorAll("input[type=xmax]")[0],i=a.querySelectorAll("input[type=ymax]")[0];if(!(f&&g&&h&&i))return null;var j=f.getAttribute("name")?f.getAttribute("name").trim():"xmin",k=g.getAttribute("name")?g.getAttribute("name").trim():"ymin",l=h.getAttribute("name")?h.getAttribute("name").trim():"xmax",m=i.getAttribute("name")?i.getAttribute("name").trim():"ymax",n="";n+=j+"={"+j+"}&",n+=k+"={"+k+"}&",n+=l+"={"+l+"}&",n+=m+"={"+m+"}";var o=a.querySelectorAll("input[type=zoom]")[0];if(!o||!d)return null;var p=parseInt(o.getAttribute("min")),q=parseInt(o.getAttribute("max")),r={},s=this._map.getZoom();if(!(p<=s&&s<=q))return null;r.zoom=s;var t=o.getAttribute("name")?o.getAttribute("name").trim():"zoom",u=t+"={"+t+"}";r.xmin=c.min?c.min.x:c.getWest(),r.ymin=c.min?c.min.y:c.getSouth(),r.xmax=c.max?c.max.x:c.getEast(),r.ymax=c.max?c.max.y:c.getNorth(),r.projection=e;var v=d.getAttribute("name")?d.getAttribute("name").trim():"projection",w=v+"={"+v+"}",x=n+"&"+u+"&"+w,y=new URI(this._href);b+=(b.search(/\?/g)===-1?"?":"&")+x;var z=new URI(b).resolve(y).toString();return L.Util.template(z,r)},_projectionMatches:function(a){a=a||this._map;var b=this.getProjection();return!(!a.options.projection||"WGS84"!==b&&a.options.projection!==b)}}),d.mapMLLayer=function(a,c,e){return new d.MapMLLayer(a,c?c:b.createElement("div"),e)},d.MapMLTileLayer=L.TileLayer.extend({getEvents:function(){var a={zoom:this._resetView,moveend:this._onMoveEnd};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},_onMoveEnd:function(){this._map&&(this._update(),this._pruneTiles())},_update:function(){if(this._map){var a=this._map,b=a.getZoom();if(!(b>this.options.maxZoom||b<this.options.minZoom)){var c=this._groupTiles(this._el.getElementsByTagName("tile"));c.length&&this._addTiles(c)}}},_groupTiles:function(a){function b(a,b){var c={};return a.forEach(function(a){var d=JSON.stringify(b(a));c[d]=c[d]||[],c[d].push(a)}),Object.keys(c).map(function(a){return c[a]})}for(var c=[],d=0;d<a.length;d++){var e={};e.row=parseInt(a[d].getAttribute("row")),e.col=parseInt(a[d].getAttribute("col")),e.src=a[d].getAttribute("src"),c.push(e)}return b(c,function(a){return[a.row,a.col]})},_addTiles:function(a){for(var c=[],d={},e=0;e<a.length;e++)d.col=a[e][0].col,d.row=a[e][0].row,this._isValidTile(new L.Point(d.col,d.row))&&c.push(a[e]);var f=c.length;if(0!==f){var g=b.createDocumentFragment();for(this._loading||(this._loading=!0,this.fire("loading")),e=0;e<f;e++)this._addTile(c[e],g);Polymer.dom(this._level.el).appendChild(g)}},_addTile:function(a,c){var d=new L.Point(a[0].col,a[0].row),e=this._getTilePos(d);e.z=this._map.getZoom();for(var f,g=this._tileCoordsToKey(e),h=0;h<a.length;h++)f=this.createTile(a[h].src),this._initTile(f),setTimeout(L.bind(this._tileReady,this,e,null,f),0),a[h].img=f;var i;if(this._tiles[g])i=this._tiles[g].el;else for(i=b.createElement("div"),h=0;h<a.length;h++)Polymer.dom(i).appendChild(a[h].img);L.DomUtil.setPosition(i,e),this._tiles[g]={el:i,coords:e,current:!0},Polymer.dom(c).appendChild(i),this.fire("tileloadstart",{tile:f,coords:e})},createTile:function(a){var c=b.createElement("img");return this.options.crossOrigin&&(c.crossOrigin=""),c.alt="",c.src=a,L.DomUtil.addClass(c,"leaflet-tile-loaded"),c},_abortLoading:function(){var a,b;for(a in this._tiles){tileDiv=this._tiles[a].el;var c=tileDiv.getElementsByTagName("img");for(a=0;a<c.length;a++)b=c[a],b.onload=L.Util.falseFn,b.onerror=L.Util.falseFn,b.complete||(b.src=L.Util.emptyImageUrl,L.DomUtil.remove(b))}}}),d.mapMLTileLayer=function(a,b){return new d.MapMLTileLayer(a,b)},d.MapMLFeatures=L.FeatureGroup.extend({initialize:function(a,b){L.setOptions(this,b),this._layers={},a&&this.addData(a)},addData:function(a){var c,e,f,g=a.nodeType===Node.DOCUMENT_NODE||"LAYER-"===a.nodeName?a.getElementsByTagName("feature"):null,h=a.nodeType===Node.DOCUMENT_NODE?a.querySelector("link[rel=stylesheet]"):null;if(h){var i=a.querySelector("base"),j=new URI(i?i.getAttribute("href"):a.baseURI),k=new URI(h.getAttribute("href"));h=k.resolve(j).toString()}if(h&&!b.head.querySelector("link[href='"+h+"']")){var l=b.createElementNS("http://www.w3.org/1999/xhtml","link");l.setAttribute("href",h),l.setAttribute("type","text/css"),l.setAttribute("rel","stylesheet"),b.head.appendChild(l)}if(g){for(c=0,e=g.length;c<e;c++){f=g[c];var m=f.getElementsByTagName("geometry").length&&f.getElementsByTagName("coordinates").length;m&&this.addData(f)}return this}var n=this.options;if(!n.filter||n.filter(a)){var o=d.MapMLFeatures.geometryToLayer(a,n.pointToLayer,n.coordsToLatLng,n);return o.feature=a.getElementsByTagName("properties")[0],o.options.className=a.getAttribute("class")?a.getAttribute("class"):null,o.defaultOptions=o.options,this.resetStyle(o),n.onEachFeature&&n.onEachFeature(o.feature,o),this.addLayer(o)}},resetStyle:function(a){var b=this.options.style;b&&(L.Util.extend(a.options,a.defaultOptions),this._setLayerStyle(a,b))},setStyle:function(a){this.eachLayer(function(b){this._setLayerStyle(b,a)},this)},_setLayerStyle:function(a,b){"function"==typeof b&&(b=b(a.feature)),a.setStyle&&a.setStyle(b)}}),L.extend(d.MapMLFeatures,{geometryToLayer:function(a,b,c,d){function e(a,b,c){var d=[];a.split(/\s+/gi).forEach(f,d),this.push(d)}function f(a,b,c){this.push(parseFloat(a))}var g,h,i,j,k="FEATURE"===a.tagName.toUpperCase()?a.getElementsByTagName("geometry")[0]:a,l=k.getElementsByTagName("coordinates");switch(c=c||this.coordsToLatLng,k.firstElementChild.tagName.toUpperCase()){case"POINT":j=[],l[0].textContent.split(/\s+/gi).forEach(f,j),g=c(j);var m=L.Icon.Default.imagePath+"/",n=d.opacity?d.opacity:null;return b?b(a,g):new L.Marker(g,{opacity:n,icon:L.icon({iconUrl:m+"marker-icon.png",iconRetinaUrl:m+"marker-icon-2x.png",shadowUrl:m+"marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})});case"MULTIPOINT":throw new Error("Not implemented yet");case"LINESTRING":return j=[],l[0].textContent.match(/(\S+ \S+)/gi).forEach(e,j),h=this.coordsToLatLngs(j,0,c),new L.Polyline(h,d);case"POLYGON":for(j=new Array(l.length),i=0;i<l.length;i++)j[i]=[],l[i].textContent.match(/(\S+ \S+)/gi).forEach(e,j[i]);return h=this.coordsToLatLngs(j,1,c),new L.Polygon(h,d);case"MULTILINESTRING":throw new Error("Not implemented yet");case"MULTIPOLYGON":throw new Error("Not implemented yet");case"GEOMETRYCOLLECTION":throw new Error("Not implemented yet");default:throw new Error("Invalid GeoJSON object.")}},coordsToLatLng:function(a){return new L.LatLng(a[1],a[0],a[2])},coordsToLatLngs:function(a,b,c){var d,e,f,g=[];for(e=0,f=a.length;e<f;e++)d=b?this.coordsToLatLngs(a[e],b-1,c):(c||this.coordsToLatLng)(a[e]),g.push(d);return g},latLngToCoords:function(a){var b=[a.lng,a.lat];return a.alt!==c&&b.push(a.alt),b},latLngsToCoords:function(a){for(var b=[],c=0,d=a.length;c<d;c++)b.push(L.MapML.latLngToCoords(a[c]));return b}}),d.mapMlFeatures=function(a,b){return new d.MapMLFeatures(a,b)},d.MapMLLayerControl=L.Control.Layers.extend({initialize:function(a,b){L.setOptions(this,b),this.options.collapsed=!1,this._layers={},this._lastZIndex=0,this._handlingClick=!1;for(var c in a)this._addLayer(a[c],c,!0)},onAdd:function(){return this._initLayout(),this._map.on("moveend",this._validateExtents,this),this._update(),this._validateExtents(),this._container},onRemove:function(a){a.off("moveend",this._validateExtents,this);for(var b in this._layers)this._layers[b].layer.off("add remove",this._onLayerChange,this),this._layers[b].layer.off("extentload",this._validateExtents,this)},_validateExtents:function(a){var b,c,d,e,f,g=this._map.getZoom(),h=this._map.getPixelBounds();for(c in this._layers)d=this._layers[c],(d.layer._extent||d.layer.error)&&(b=d.layer.getZoomBounds(),f=d.layer._projectionMatches(this._map),e=f&&this._withinZoomBounds(g,b)&&h.intersects(d.layer.getLayerExtentBounds(this._map)),e?(d.input.disabled=!1,d.input.style=null,d.input.nextElementSibling.style.fontStyle=""):(d.input.disabled=!0,f||(this._map.removeLayer(d.layer),d.input.disabled=!0,d.input.checked=!1),d.input.nextElementSibling.style.fontStyle="italic"),this._setLegendLink(d,d.input.nextElementSibling))},_withinZoomBounds:function(a,b){return b.min<=a&&a<=b.max},_setLegendLink:function(a,c){if(a.layer._legendUrl){var d=b.createElement("a");d.text=" "+a.name,d.href=a.layer._legendUrl,d.target="_blank",c.innerHTML="",c.appendChild(d)}else c.innerHTML=" "+a.name},_addItem:function(a){var c,d=b.createElement("label"),e=this._map.hasLayer(a.layer);c=b.createElement("input"),c.type="checkbox",c.className="leaflet-control-layers-selector",c.defaultChecked=e,a.input=c,c.layerId=L.stamp(a.layer),L.DomEvent.on(c,"click",this._onInputClick,this);var f=b.createElement("span");this._setLegendLink(a,f),Polymer.dom(d).appendChild(c),Polymer.dom(d).appendChild(f);var g=this._overlaysList;return Polymer.dom(g).appendChild(d),a.layer.on("extentload",this._validateExtents,this),d}}),d.mapMlLayerControl=function(a,b){return new d.MapMLLayerControl(a,b)}}(window,document);
